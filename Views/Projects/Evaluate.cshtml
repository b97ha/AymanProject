@model AymanProject.Models.Project
@{
    ViewData["Title"] = "Evaluate";
    var lang = Context.Items["Lang"]?.ToString() ?? "en";
    bool isArabic = lang == "ar";

    // Get existing evaluations for this project
    var project = ViewBag.Project as AymanProject.Models.Project;

    var projectEvaluations = project.ProjectMainCriterians;
}

<div class="container mt-4" dir="@(isArabic ? "rtl" : "ltr")">
    <div class="card shadow">
        <div class="card-header bg-info text-white">
            <h3 class="card-title mb-0">
                @(isArabic ? "تقييم المشروع" : "Project Evaluation")
                <span class="text-end">
                    @(project.Title)
                </span>
            </h3>


        </div>

        <form asp-action="SaveEvaluation" method="post">
            <input type="hidden" name="projectId" value="@Model.Id" />
            <input type="hidden" name="lang" value="@lang" />

            <div class="card-body">
                @foreach (var mainCriterian in ViewBag.MainCriterians)
                {
                    // Check if this main criterian has existing evaluation
                    var existingEvaluation = projectEvaluations?
                    .FirstOrDefault(pmc => pmc.MainCriterianId == mainCriterian.Id);
                    var isChecked = existingEvaluation != null;
                    var mainEvaluationValue = existingEvaluation?.UserEvaluation ?? 50;

                    <div class="card mb-3">
                        <div class="card-header">
                            <div class="form-check form-switch">
                                <input class="form-check-input main-criterian-check"
                                       type="checkbox"
                                       id="main-@mainCriterian.Id"
                                       name="selectedMainCriterians"
                                       value="@mainCriterian.Id"
                                @(isChecked ? "checked" : "")>
                                <label class="form-check-label fw-bold" for="main-@mainCriterian.Id">
                                    @(isArabic ? mainCriterian.Text_Ar : mainCriterian.Text_En)
                                </label>
                            </div>
                        </div>

                        <div class="card-body sub-criterians" style="@(isChecked ? "" : "display: none;")">
                            <!-- Main evaluation slider -->
                            <div class="mb-3">
                                <label>@(isArabic ? "التقييم الرئيسي" : "Main Evaluation")</label>
                                <input type="range" class="form-range main-evaluation"
                                       name="mainEvaluations"
                                       data-main-id="@mainCriterian.Id"
                                       min="0" max="100" step="5"
                                       value="@mainEvaluationValue">
                                <span class="evaluation-value">@mainEvaluationValue%</span>
                            </div>

                            <!-- Sub-criterians -->
                            @foreach (var subCriterian in mainCriterian.SubCriterians)
                            {
                                var subEvaluationValue = existingEvaluation?.ProjectSubCriterians?
                                .FirstOrDefault(psc => psc.SubCriterianId == subCriterian.Id)?.UserEvaluation ?? 50;

                                <div class="mb-2">
                                    <label>@(isArabic ? subCriterian.Text_Ar : subCriterian.Text_En)</label>
                                    <input type="hidden" name="subCriterianIds" value="@subCriterian.Id" />
                                    <input type="range" class="form-range"
                                           name="subEvaluations"
                                           min="0" max="100" step="5"
                                           value="@subEvaluationValue">
                                    <span class="evaluation-value">@subEvaluationValue%</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="card-footer bg-light">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> @(isArabic ? "حفظ التقييم" : "Save Evaluation")
                </button>
                <a asp-action="Details" asp-route-id="@Model.Id" asp-route-lang="@lang"
                   class="btn btn-secondary">
                    @(isArabic ? "إلغاء" : "Cancel")
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize existing checked items
            $('.main-criterian-check:checked').each(function() {
                $(this).closest('.card').find('.sub-criterians').show();
            });

            // Toggle sub-criterians when main checkbox is clicked
            $('.main-criterian-check').change(function() {
                $(this).closest('.card').find('.sub-criterians').toggle(this.checked);
            });

            // Update percentage display when range sliders change
            $('input[type="range"]').on('input', function() {
                $(this).next('.evaluation-value').text($(this).val() + '%');
            });
        });
    </script>
}